/*!
 * DonkyData JavaScript Library
 *
 * Copyright (C) Donky Networks Ltd. All rights reserved.
 *
 */
var DonkyData=(function(){var b,c=null;var e={namespace:"donky.net.core."};var d={_get:function(f){return localStorage.getItem(e.namespace+f)},get:function(g){var i=null;var f=this._get(g);try{i=JSON.parse(f)}catch(h){console.log("caught exception in _db.get("+g+"): "+h)}return i},_set:function(f,g){localStorage.setItem(e.namespace+f,g)},set:function(g,h){try{var f=JSON.stringify(h);this._set(g,f)}catch(i){console.log("caught exception in _db.set("+g+"): "+i)}},remove:function(f){localStorage.removeItem(e.namespace+f)},removeAll:function(f){c._each(f,function(g,h){b.remove(h)})},lsTest:function(){var g="test";try{localStorage.setItem(g,g);localStorage.removeItem(g);return true}catch(f){return false}},clearDonkyLocalStorage:function(){for(var f in localStorage){if(f.indexOf(e.namespace)===0){localStorage.removeItem(f)}}}};function a(f){if(typeof b!="undefined"){return b}if(!d.lsTest()){throw new Error("Local storage not available")}if(f===undefined||f===null){throw new Error("no options specified")}if(f.donkyCore===undefined){throw new Error("donkyCore not specified")}c=f.donkyCore;c._extend(e,f);b=this;return b}a.prototype={_getNamespace:function(){return e.namespace},_setNamespace:function(f){e.namespace=f},get:function(f){return d.get(f)},set:function(f,g){d.set(f,g)},getString:function(f){return d._get(f)},setString:function(f,g){d._set(f,g)},remove:function(f){d.remove(f)},clearDonkyLocalStorage:function(){d.clearDonkyLocalStorage()},};return a})();;/*!
 * DonkyAccount JavaScript Library v1.0.0.0
 *
 * Copyright (C) Dynmark. All rights reserved.
 *
 */
var DonkyAccount=(function(){var l,k=null;var f={tokenExpiryCheckInterval:10000};var j=null;var d=false;var h;var g=false;var m=false;function a(n){if(typeof l!="undefined"){return l}if(n===undefined||n===null){throw new Error("no options specified")}if(n.donkyCore===undefined){throw new Error("donkyCore not specified")}k=n.donkyCore;l=this;k.subscribeToLocalEvent("DonkyInitialised",function(o){if(j===null){j=setInterval(function(){l._checkToken(function(){})},f.tokenExpiryCheckInterval)}});k.subscribeToLocalEvent("DonkyUninitialised",function(o){if(j!==null){clearInterval(j);j=null}});k.subscribeToDonkyNotifications({name:"donkyCore",version:k.version()},[{notificationType:"UserUpdated",handler:function(o){var p=l.getRegistrationDetails().userDetails;p.id=o.data.newExternalUserId!==undefined?o.data.newExternalUserId:o.data.externalUserId;p.displayName=o.data.displayName;p.firstName=o.data.firstName;p.lastName=o.data.lastName;p.emailAddress=o.data.emailAddress;p.countryCode=o.data.countryIsoCode;p.mobileNumber=o.data.phoneNumber;p.isAnonymous=o.data.isAnonymous;p.avatarAssetId=o.data.avatarAssetId;p.additionalProperties=o.data.additionalProperties;k.donkyData.set("userDetails",p);k.publishLocalEvent({type:"UserUpdated",data:p})}}],true);return l}a.prototype._getBrowserInfo=function(){var o=navigator.userAgent,n,p=o.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(/trident/i.test(p[1])){n=/\brv[ :]+(\d+)/g.exec(o)||[];return{name:"IE",version:n[1]||""}}if(p[1]==="Chrome"){n=o.match(/\bOPR\/(\d+)/);if(n!==null){return{name:"Opera",version:n[1]}}}p=p[2]?[p[1],p[2]]:[navigator.appName,navigator.appVersion,"-?"];if((n=o.match(/version\/(\d+)/i))!==null){p.splice(1,1,n[1])}return{name:p[0],version:p[1]}};a.prototype._isTokenExpired=function(){var s=k.donkyData.get("accessDetails");if(s!==null&&s!==undefined){var q=false;var o=new Date(s.expiresOn);var p=new Date();if(o>p){var n=Math.abs(p.getTime()-o.getTime());var r=Math.ceil(n/1000);if(r<60){q=true}}else{q=true}return q}else{return true}};a.prototype._checkToken=function(p,n){if((l.isRegistered()&&!l._isSuspended())||n===true){var o=l._isTokenExpired();if(o&&!g){if(k.donkyData.get("usingAuth")===true){this._refreshTokenWithAuth(p)}else{this._refreshToken(p)}}else{p({succeeded:true})}}else{p({succeeded:false})}};a.prototype._refreshTokenWithAuth=function(p){if(!k._isFunction(p)){throw new Error("resultHandler not supplied")}if(g===true){p({succeeded:false});return}g=true;var o=true;var n=k.donkyNetwork._getSignalRState();switch(n){case k.donkyNetwork.signalrStatuses.initializing:case k.donkyNetwork.signalrStatuses.starting:case k.donkyNetwork.signalrStatuses.started:k.donkyNetwork._stopSignalR();break;default:break}e(function(q){if(q.succeeded){var s=q.response.authenticationId;var t=k.donkyData.get("userDetails");var r={nonce:q.response.nonceRequired?q.response.nonce:undefined,expectedUserId:t!==null?t.id:undefined};l.onAuthenticationChallenge(r,function(u){var v={authenticationDetail:{provider:"JsonWebToken",token:u,authenticationId:s},networkId:k.donkyData.get("networkId"),deviceSecret:k.donkyData.get("secret"),operatingSystem:l._getOperatingSystem(),sdkVersion:k.version()};c(v,function(w){console.log(JSON.stringify(w,null,4));if(w.succeeded){k.donkyLogging.debugLog("Succesfully refreshed authorization token");k.donkyData.set("configuration",w.response.configuration);delete w.response.configuration;k.donkyData.set("accessDetails",w.response);k.donkyData.remove("isSuspended");if(o){k.donkyNetwork._startSignalR()}g=false;return(p({succeeded:true}))}else{k.donkyLogging.warnLog("Failed to  refresh authorization token");if(w.statusCode==400&&w.response[0].failureKey==="UserNotFound"){var x={userDetails:k.donkyData.get("userDetails"),deviceDetails:k.donkyData.get("deviceDetails")};l._registerUsingAuthentication(x,function(y){g=false;return(p(y))})}else{if(w.statusCode==403){k.donkyLogging.warnLog("Can't refresh token - have been suspended");k.donkyData.set("isSuspended",true)}else{g=false}}return(p(w))}})})}else{g=false}})};a.prototype._refreshToken=function(q){if(!k._isFunction(q)){throw new Error("resultHandler not supplied")}var p=false;var n=k.donkyNetwork._getSignalRState();switch(n){case k.donkyNetwork.signalrStatuses.initializing:case k.donkyNetwork.signalrStatuses.starting:case k.donkyNetwork.signalrStatuses.started:k.donkyNetwork._stopSignalR();p=true;break;default:break}var o={networkId:k.donkyData.get("networkId"),deviceSecret:k.donkyData.get("secret"),operatingSystem:l._getOperatingSystem(),sdkVersion:k.version()};k.donkyNetwork.ajax(o,"POST",k.donkyNetwork.api.anonymous,"authentication/gettoken",function(r){if(r.succeeded){k.donkyLogging.debugLog("Succesfully refreshed authorization token");k.donkyData.set("configuration",r.response.configuration);delete r.response.configuration;k.donkyData.set("accessDetails",r.response);k.donkyData.remove("isSuspended");if(p){k.donkyNetwork._startSignalR()}return(q({succeeded:true}))}else{k.donkyLogging.warnLog("Failed to  refresh authorization token");if(r.statusCode===401){k.donkyLogging.warnLog("Can't refresh token - have I been deleted ?");var s=l.getRegistrationDetails();l._register(s,function(t){if(p){k.donkyNetwork._startSignalR()}return(q(t))})}else{if(r.statusCode===403){k.donkyLogging.warnLog("Can't refresh token - have been suspended");k.donkyData.set("isSuspended",true)}}if(r.statusCode!==401){return(q({succeeded:false,result:r}))}}})};a.prototype._getOperatingSystem=function(){var n=k.donkyData.get("operatingSystem");return n!==null?n:"Web"};a.prototype._setOperatingSystem=function(n){k.donkyData.set("operatingSystem",n)};a.prototype._getDeviceId=function(){var n=k.donkyData.get("deviceId");if(n===null){n=k._uuid();k.donkyData.set("deviceId",n);k.donkyData.set("secret",k._uuid())}return n};a.prototype._setDeviceId=function(o){var n=false;var p=k.donkyData.get("deviceId");if(p===null){k.donkyData.set("deviceId",o);k.donkyData.set("secret",k._uuid());n=true}else{if(o!==p){k.donkyLogging.warnLog("Attempt to update deviceId from "+p+" to "+o)}}return n};a.prototype.isRegistered=function(){try{return k.donkyData.get("networkId")!==null}catch(n){k.donkyLogging.errorLog("caught exception in isRegistered() : "+n);return false}};function i(o){if(window.donkyDeviceOverrides){k.donkyLogging.infoLog("window.donkyDeviceOverrides: "+JSON.stringify(window.donkyDeviceOverrides));l._setDeviceId(window.donkyDeviceOverrides.deviceId);l._setOperatingSystem(window.donkyDeviceOverrides.operatingSystem)}var p=l._getBrowserInfo();var n={id:l._getDeviceId(),secret:k.donkyData.get("secret"),operatingSystem:l._getOperatingSystem(),operatingSystemVersion:navigator.userAgent,model:p.name+" v"+p.version};return k._extend(o,n)}a.prototype._register=function(n,p){if(!k._isFunction(p)){throw new Error("resultHandler not supplied")}if(n.deviceDetails===undefined){n.deviceDetails={}}m=true;var o={device:n.deviceDetails,user:n.userDetails,client:{sdkVersion:k.version(),moduleVersions:k._moduleVersions,appVersion:n.appVersion,currentLocalTime:new Date().toISOString()}};i(o.device);k.donkyLogging.debugLog(JSON.stringify(o));k.donkyNetwork.ajax(o,"POST",k.donkyNetwork.api.anonymous,"registration",function(r){if(r.succeeded){k.donkyData.set("networkId",r.response.networkId);k.donkyData.set("networkProfileId",r.response.networkProfileId);var s=r.response.accessDetails.configuration;delete r.response.accessDetails.configuration;k.donkyData.set("configuration",s);k.donkyData.set("accessDetails",r.response.accessDetails);var q=o.user!==undefined?o.user:{id:r.response.userId};q.isAnonymous=o.user===undefined;if(q.displayName===undefined){q.displayName=r.response.userId}delete o.device.id;delete o.device.secret;k.donkyData.set("userDetails",q);k.donkyData.set("deviceDetails",o.device);k.donkyData.set("clientDetails",o.client);k.publishLocalEvent({type:"RegistrationChanged",data:{userDetails:q,deviceDetails:o.device,configuration:s}})}m=false;p(r)})};a.prototype.getRegistrationDetails=function(){try{if(d){k.donkyLogging.warnLog("A call to update details is in progress, this data is stale ...")}return{userDetails:k.donkyData.get("userDetails"),deviceDetails:k.donkyData.get("deviceDetails")}}catch(n){k.donkyLogging.errorLog("caught exception in getRegistrationDetails() : "+n);return null}};a.prototype.getDevice=function(){try{if(d){k.donkyLogging.warnLog("A call to update details is in progress, this data is stale ...")}var o=l._getBrowserInfo();var n=k.donkyData.get("deviceDetails");if(n===null){n={operatingSystem:l._getOperatingSystem(),operatingSystemVersion:navigator.userAgent,model:o.name+" v"+o.version}}return n}catch(p){k.donkyLogging.errorLog("caught exception in getDevice() : "+p);return null}};a.prototype._getClient=function(){if(d){k.donkyLogging.warnLog("A call to update details is in progress, this data is stale ...")}return k.donkyData.get("clientDetails")};a.prototype.updateRegistrationDetails=function(o,n){try{if(!k._isFunction(n)){throw new Error("callback not supplied")}if(o===undefined||o===null){throw new Error("settings not supplied")}if(o.userDetails!==undefined&&o.deviceDetails!==undefined){l._updateRegistrationDetails(o,n)}else{if(o.userDetails!==undefined){l.updateUserDetails(o.userDetails,n)}else{if(o.deviceDetails!==undefined){l.updateDeviceDetails(o.deviceDetails,n)}else{throw new Error("neither userDetails or deviceDetails specified - must specify at least 1")}}}}catch(p){k.donkyLogging.errorLog("caught exception in updateRegistrationDetails() : "+p)}};a.prototype.replaceRegistration=function(o,n){try{k.donkyNetwork.synchronise(function(){if(k.donkyData.get("usingAuth")===true){l._registerUsingAuthentication(o,function(q){n(q)})}else{l._register(o,function(q){n(q)})}})}catch(p){k.donkyLogging.errorLog("caught exception in replaceRegistration() : "+p)}};a.prototype._updateRegistrationDetails=function(r,s){var p={user:r.userDetails,device:r.deviceDetails};if(d===true){return(s({succeeded:false,response:{failedClientNotifications:[{failureReason:"Cannot call _updateRegistrationDetails() when a previous update is still in progress"}]}}))}if(k.donkyData.get("usingAuth")===true){if(k.donkyData.get("userDetails").id!==r.userDetails.id){return(s({succeeded:false,response:{failedClientNotifications:[{failureReason:"Cannot Update UserId if using Authentication"}]}}))}}var o=k.donkyData.get("userDetails");var q=o!==null?o.id:undefined;var n=q!==r.userDetails.id&&q!==undefined;i(p.device);d=true;k.donkyNetwork.ajax(p,"PUT",k.donkyNetwork.api.secure,"registration",function(t){d=false;if(t.succeeded){k.donkyData.set("userDetails",p.user);delete p.device.id;delete p.device.secret;k.donkyData.set("deviceDetails",p.device);if(n){l._refreshToken(function(){s(t)})}else{s(t)}}else{if(t.statusCode===400){var u=t.response.filter(function(v){return v.failureKey==="UserIdAlreadyTaken"});if(u.length===1){k.donkyLogging.warnLog("UserIdAlreadyTaken");l._register(r,function(v){s(v)})}else{s(t)}}else{s(t)}}})};a.prototype.updateUserDetails=function(s,r){try{if(s===undefined){throw new Error("userDetails not supplied")}if(!k._isFunction(r)){throw new Error("callback not supplied")}if(k.donkyData.get("usingAuth")===true){if(k.donkyData.get("userDetails").id!==s.id){return(r({succeeded:false,response:{failedClientNotifications:[{failureReason:"Cannot Update UserId if using Authentication"}]}}))}}if(d===true){return(r({succeeded:false,response:{failedClientNotifications:[{failureReason:"Cannot call updateUserDetails() when a previous update is still in progress"}]}}))}var o=k.donkyData.get("userDetails");var p=o!==null?o.id:undefined;var n=p!==s.id&&p!==undefined;d=true;k.donkyNetwork.ajax(s,"PUT",k.donkyNetwork.api.secure,"registration/user",function(t){d=false;if(t.succeeded){k.donkyData.set("userDetails",s);if(n){l._refreshToken(function(){r(t)})}else{r(t)}}else{if(t.statusCode===400){var u=t.response.filter(function(w){return w.failureKey==="UserIdAlreadyTaken"});if(u.length===1){k.donkyLogging.warnLog("UserIdAlreadyTaken");var v={userDetails:s,deviceDetails:k.donkyData.get("deviceDetails")};l._register(v,function(w){r(w)})}else{r(t)}}else{r(t)}}})}catch(q){k.donkyLogging.errorLog("caught exception in updateUserDetails() : "+q)}};a.prototype.updateDeviceDetails=function(n,p){try{if(n===undefined){throw new Error("deviceDetails not supplied")}if(!k._isFunction(p)){throw new Error("callback not supplied")}if(d===true){return(p({succeeded:false,response:{failedClientNotifications:[{failureReason:"Cannot call updateDeviceDetails() when a previous update is still in progress"}]}}))}i(n);d=true;k.donkyNetwork.ajax(n,"PUT",k.donkyNetwork.api.secure,"registration/device",function(q){d=false;if(q.succeeded){delete n.id;delete n.secret;k.donkyData.set("deviceDetails",n)}p(q)})}catch(o){k.donkyLogging.errorLog("caught exception in updateDeviceDetails() : "+o)}};a.prototype._updateClient=function(n,p){try{if(!k._isFunction(p)){throw new Error("callback not supplied")}if(d===true){return(p({succeeded:false,response:{failedClientNotifications:[{failureReason:"Cannot call _updateClient() when a previous update is still in progress"}]}}))}d=true;k.donkyNetwork.ajax(n,"PUT",k.donkyNetwork.api.secure,"registration/client",function(q){d=false;if(q.succeeded){k.donkyData.set("clientDetails",n)}p(q)})}catch(o){k.donkyLogging.errorLog("caught exception in _updateClient() : "+o)}};a.prototype._isSuspended=function(){var n=k.donkyData.get("isSuspended");return n!==null?n:false};a.prototype.getTags=function(o){try{if(!k._isFunction(o)){throw new Error("callback not supplied")}k.donkyNetwork.ajax(null,"GET",k.donkyNetwork.api.secure,"registration/user/tags",function(p){o(p)})}catch(n){k.donkyLogging.errorLog("caught exception in getTags() : "+n)}};a.prototype.putTags=function(n,p){try{if(!k._isFunction(p)){throw new Error("callback not supplied")}k.donkyNetwork.ajax(n,"PUT",k.donkyNetwork.api.secure,"registration/user/tags",function(q){p(q)})}catch(o){k.donkyLogging.errorLog("caught exception in putTags() : "+o)}};a.prototype._registerUsingAuthentication=function(n,o){if(!k._isFunction(o)){throw new Error("callback not supplied")}m=true;e(function(p){if(p.succeeded){var r=p.response.authenticationId;var s=k.donkyData.get("userDetails");var q={nonce:p.response.nonceRequired?p.response.nonce:undefined,expectedUserId:s!==null?s.id:undefined};l.onAuthenticationChallenge(q,function(t){var u={authenticationDetail:{provider:"JsonWebToken",token:t,authenticationId:r},user:n.userDetails,device:n.deviceDetails,isReregistration:false};b(u,function(v){m=false;o(v)})})}else{m=false;o(p)}})};a.prototype.register=function(n,o){if(!k._isFunction(o)){throw new Error("callback not supplied")}if(k.getInitialisationStatus()!==k.initialisationStatus.initialisingPendingRegistration){return o({success:false,data:{message:"SDK Must be in initialisingPendingRegistration state"}})}if(l.isRegistered()){return o({success:false,data:{message:"A registered user already exists - use replaceRegistration() instead"}})}if(m){return o({success:false,data:{message:"A registered user already exists - use replaceRegistration() instead"}})}l._register(n,function(p){if(p.succeeded){k.publishLocalEvent({type:"DonkyInitialised",data:{}})}o(p)})};a.prototype.registerAuthenticated=function(n,o){if(!k._isFunction(o)){throw new Error("callback not supplied")}if(k.getInitialisationStatus()!==k.initialisationStatus.initialisingPendingRegistration){return o({success:false,data:{message:"SDK Must be in initialisingPendingRegistration state"}})}if(m){return o({success:false,data:{message:"A registered user already exists - use replaceRegistration() instead"}})}if(l.isRegistered()){return o({success:false,data:{message:"A registered user already exists - use replaceRegistration() instead"}})}l._registerUsingAuthentication(n,function(p){if(p.succeeded){k.publishLocalEvent({type:"DonkyInitialised",data:{}})}o(p)})};function e(o){try{if(!k._isFunction(o)){throw new Error("callback not supplied")}k.donkyNetwork.ajax(null,"GET",k.donkyNetwork.api.anonymous,"authentication/start",function(p){o(p)})}catch(n){k.donkyLogging.errorLog("caught exception in authenticationStart() : "+n)}}function b(n,p){try{if(!k._isFunction(p)){throw new Error("callback not supplied")}if(n.device===undefined){n.device={}}i(n.device);n.client={sdkVersion:k.version(),moduleVersions:k._moduleVersions,currentLocalTime:new Date().toISOString()};k.donkyNetwork.ajax(n,"POST",k.donkyNetwork.api.anonymous,"authenticatedregistration",function(r){if(r.succeeded){k.donkyData.set("usingAuth",true);k.donkyData.set("networkId",r.response.networkId);k.donkyData.set("networkProfileId",r.response.networkProfileId);var s=r.response.accessDetails.configuration;delete r.response.accessDetails.configuration;k.donkyData.set("configuration",s);k.donkyData.set("accessDetails",r.response.accessDetails);var q=n.user!==undefined?n.user:{id:r.response.userId};q.id=r.response.userId;if(q.displayName===undefined){q.displayName=r.response.userId}delete n.device.id;delete n.device.secret;k.donkyData.set("userDetails",q);k.donkyData.set("deviceDetails",n.device);k.donkyData.set("clientDetails",n.client);k.publishLocalEvent({type:"RegistrationChanged",data:{userDetails:q,deviceDetails:n.device,configuration:s}})}p(r)})}catch(o){k.donkyLogging.errorLog("caught exception in authenticatedRegistration() : "+o)}}function c(n,p){try{if(!k._isFunction(p)){throw new Error("callback not supplied")}k.donkyNetwork.ajax(n,"POST",k.donkyNetwork.api.anonymous,"authentication/reauthenticate",function(q){p(q)})}catch(o){k.donkyLogging.errorLog("caught exception in _reauthenticate() : "+o)}}a.prototype._isRefreshingToken=function(){return g};a.prototype.onAuthenticationChallenge=h;a.prototype.isPushEnabled=function(){return k.donkyData.get("isPushEnabled")};a.prototype.enablePush=function(n,p){if(n){var o=k.donkyData.get("pushConfig");if(o!==null){l.sendPushConfiguration(o,p)}else{p({succeeded:false})}}else{l.deletePushConfiguration(p)}};a.prototype.sendPushConfiguration=function(q,p){try{if(!k._isFunction(p)){throw new Error("callback not supplied")}var n={};switch(l._getOperatingSystem()){case"Web":return p({succeeded:false,data:{message:"sendPushConfiguration not supported for 'Web'"}});case"iOS":n.type="Apns";n.token=q.registrationId;n.bundleId=q.bundleId;n.messageAlertSound="Default";break;case"Android":n.type="Gcm";n.registrationId=q.registrationId;break;default:return p({succeeded:false,data:{message:"Unknown operating system '"+l._getOperatingSystem()+"'"}})}k.donkyNetwork.ajax(n,"PUT",k.donkyNetwork.api.secure,"registration/push",function(r){if(r.succeeded){k.donkyData.set("isPushEnabled",true);k.publishLocalEvent({type:"PushEnabled",data:true})}p(r)})}catch(o){k.donkyLogging.errorLog("caught exception in sendPushConfiguration() : "+o)}};a.prototype.deletePushConfiguration=function(n){k.donkyNetwork.ajax({},"DELETE",k.donkyNetwork.api.secure,"registration/push",function(o){if(o.succeeded){k.donkyData.set("isPushEnabled",false);k.publishLocalEvent({type:"PushEnabled",data:false})}n(o)})};return a})();;/*!
 * DonkyLogging JavaScript Library
 *
 * Copyright (C) Donky Networks Ltd. All rights reserved.
 *
 */
var DonkyLogging=(function(){var a={Fatal:0,Error:1,Warn:2,Info:3,Debug:4};var h={0:"Fatal",1:"Error",2:"Warn",3:"Info",4:"Debug"};var b;var g={logLevel:a.Error,maxSize:1024*10,key:"rollingLogfile"};var d=null;var c=("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4);function f(m,l,i){if(m<=g.logLevel){var k="["+c+"] : "+new Date().toJSON()+" ["+h[m]+"] : "+l+(i!==undefined?(" : "+JSON.stringify(i)):"")+"\r\n";switch(m){case a.Fatal:case a.Error:console.error(k);break;case a.Warn:console.warn(k);break;default:console.log(k);break}var j=d.donkyData.getString(g.key);if(j!==null){j+=k}else{j=k}if(j.length>g.maxSize){j=j.substring(k.length)}d.donkyData.setString(g.key,j);d.publishLocalEvent({type:"LogMessage",data:{logLevel:m,message:l,args:i}})}}function e(i){if(typeof b!="undefined"){return b}if(i===undefined||i===null){throw new Error("no options specified")}if(i.donkyCore===undefined){throw new Error("No donkyCore specified")}d=i.donkyCore;b=this;return b}e.prototype={_submitAutomaticErrorLog:function(){var i=d.donkyData.get("configuration");if(i!==null&&i!==undefined){if(i.configurationItems!==undefined&&i.configurationItems.AlwaysSubmitErrors=="true"){d._submitLog("AutomaticByDevice")}}},fatalLog:function(j,i){if(a.Fatal<=g.logLevel){f(a.Fatal,j,i);d._submitLog("AutomaticByDevice")}},errorLog:function(j,i){if(a.Error<=g.logLevel){f(a.Error,j,i);d._submitLog("AutomaticByDevice")}},warnLog:function(j,i){if(a.Warn<=g.logLevel){f(a.Warn,j,i)}},infoLog:function(j,i){if(a.Info<=g.logLevel){f(a.Info,j,i)}},debugLog:function(j,i){if(a.Debug<=g.logLevel){f(a.Debug,j,i)}},getLog:function(){return d.donkyData.getString(g.key)},clearLog:function(){return d.donkyData.remove(g.key)},logLevel:a,_getLogLevel:function(){return g.logLevel},_setLogLevel:function(i){if(i>=a.Fatal&&i<=a.Debug){g.logLevel=i}},_getMaxSize:function(){return g.maxSize},_setMaxSize:function(i){if(i>=0&&i<=1024*1024){g.maxSize=i}}};return e})();;/*!
 * DonkyNetwork JavaScript Library
 *
 * Copyright (C) Donky Networks Ltd. All rights reserved.
 *
 */
var DonkyNetwork=(function(){var m={checkSynchroniseInterval:1000*10,maxSecondsWithoutSynchronize:5*60,retrySchedule:[5000,5000,30000,30000,60000,120000,300000,300000,300000,300000,300000,300000,300000,300000,300000,600000,600000,600000,600000,600000,600000,900000]};var a;var h=null;var f=0;var d={initializing:0,starting:1,started:2,stopping:3,stopped:4,error:5};var p=false;var o;var c=false;var r;var s;var k=false;var l=d.stopped;var i=null;var g=null;var j=false;var n=true;var q=null;function e(){if(!h.donkyAccount._isRefreshingToken()){if(h.donkyAccount.isRegistered()&&!h.donkyAccount._isSuspended()){var t=h.donkyData.get("lastSynchroniseTime");if(t!==null){var u=new Date(t);var v=h._dateDiff(u,new Date());if(v.seconds>m.maxSecondsWithoutSynchronize){a.synchronise()}}else{a.synchronise()}}}}function b(u){if(typeof a!="undefined"){return a}if(u===undefined||u===null){throw new Error("no options specified")}if(u.donkyCore===undefined){throw new Error("donkyCore not specified")}h=u.donkyCore;if(window.jQuery===undefined){throw new Error("jQuery not found")}if(h._versionCompare(jQuery.fn.jquery,"1.7")<0){throw new Error("jQuery varsion too old - require minimum version of 1.7")}if(window.jQuery.signalR===undefined){throw new Error("signalR not found")}if(h._versionCompare(window.jQuery.signalR.version,"2.2.0")<0){throw new Error("signalR varsion too old - require minimum version of 2.2.0")}a=this;h.registerModule({name:"DirectMessageDelivery",version:"1.0.0"});h.subscribeToLocalEvent("RegistrationChanged",function(x){if(n){if(l==d.initializing||l==d.starting||l==d.started){a._stopSignalR(function(){a._startSignalR()})}}});h.subscribeToLocalEvent("DonkyInitialised",function(x){if(n){if(!k){a._initSignalR()}else{if(l==d.stopped){a._startSignalR()}}}if(q===null){q=setInterval(function(){e()},m.checkSynchroniseInterval)}});h.subscribeToLocalEvent("DonkyUninitialised",function(x){if(q!==null){clearInterval(q);q=null}});var w=h.donkyData.get("configuration");if(w!==null&&w!==undefined&&w.configurationItems!==undefined){if(typeof w.configurationItems.DeviceCommsConnectionRetrySchedule=="string"){var t=w.configurationItems.DeviceCommsConnectionRetrySchedule.split("|");var v=[];h._each(t,function(y,A){var C=A.split(",");if(C.length==2){var x=parseInt(C[0]);var B=C[1]==="*"?1:parseInt(C[1]);for(var z=0;z<B;z++){v.push(x*1000)}}});m.retrySchedule=v}if(n&&typeof w.configurationItems.MaxMinutesWithoutNotificationExchange=="string"){m.maxSecondsWithoutSynchronize=parseInt(w.configurationItems.MaxMinutesWithoutNotificationExchange)*60}}return a}b.prototype.api={anonymous:"client-api.mobiledonky.com/api/",secure:"client-secure-api-northeurope.mobiledonky.com/api/"};b.prototype.signalrStatuses=d;b.prototype.ajax=function(v,u,t,y,x){if(h.getInitialisationStatus()===h.initialisationStatus.uninitialised){x({succeeded:false,statusCode:-1,response:"SDK Not initialised"})}try{a._ajax(v,u,t,y,function(A){if(A.succeeded){f=0;x(A)}else{var z=true;if(h.donkyAccount._isSuspended()||!h.donkyAccount.isRegistered()){z=false}else{switch(A.statusCode){case 401:if(y!=="authentication/gettoken"){z=false;var B=h.donkyData.get("usingAuth")===true?h.donkyAccount._refreshTokenWithAuth:h.donkyAccount._refreshToken;B(function(C){if(C.succeeded){h.donkyLogging.debugLog("Retrying ajax call after getting a new token");a.ajax(v,u,t,y,x)}else{h.donkyLogging.warnLog("Failed to refresh token (not retrying ajax call)")}})}else{z=false}break;case 400:case 403:case 404:z=false;break;default:break}}if(z){h.donkyLogging.debugLog("Retrying ajax call in "+m.retrySchedule[f]+" ms - retryCounter = "+f);setTimeout(function(){a.ajax(v,u,t,y,x)},m.retrySchedule[f]);if(f<m.retrySchedule.length-1){f++}}else{x(A)}}})}catch(w){h.donkyLogging.errorLog("caught exception in ajax() : "+w);x({succeeded:false,statusCode:-1})}};b.prototype._ajax=function(x,A,z,t,B){var v={donkyClientSystemIdentifier:"DonkyWebModularSdk"};if(z===a.api.secure){v.authorization=h.donkyNetwork._getAuthorizationHeader()}else{v.apiKey=h.donkyData.get("apiKey")}var y=h.donkyData.get("environment");var u=h.donkyData.get("scheme");var w=jQuery.ajax({url:u+y+z+t,type:A,beforeSend:function(C){if(v!==null){h._each(v,function(D,E){C.setRequestHeader(D,E)})}},contentType:"application/json",data:x!==null?JSON.stringify(x):undefined,dataType:"json"}).done(function(C){if(C!==null&&C!==undefined){h.donkyLogging.debugLog(JSON.stringify(C))}B({succeeded:true,response:C})}).fail(function(F,C,H){var I;if(F.readyState==4){var D=null;var E=F.statusCode();switch(E.status){case 400:try{D=JSON.parse(E.responseText)}catch(G){h.donkyLogging.warnLog("failed to parse responseText: "+E.responseText)}I=A+" to  "+z+t+" returned a "+E.status+" (Bad request)\nrequest: "+JSON.stringify(x)+"\nheaders: "+JSON.stringify(v)+"\nresponse: "+JSON.stringify(D);h.donkyLogging.warnLog(I);break;default:D=E.responseText;I=A+" to  "+z+t+" returned a "+E.status+"\nrequest: "+JSON.stringify(x)+"\nheaders: "+JSON.stringify(v)+"\nresponse: "+E.responseText;h.donkyLogging.warnLog(I);break}B({succeeded:false,response:D,statusCode:E.status})}else{I=A+" to  "+z+t+" failed ("+C+")\nrequest: "+JSON.stringify(x)+"\nheaders: "+JSON.stringify(v);h.donkyLogging.warnLog(I);B({succeeded:false,statusCode:-1})}})};b.prototype._initSignalR=function(){if(i===null){l=d.initializing;var t=h.donkyData.get("accessDetails");i=jQuery.hubConnection(t.signalRUrl,{useDefaultPath:false});i.qs={access_token:t.accessToken};if(h.donkyLogging._getLogLevel()>=h.donkyLogging.logLevel.Info){i.logging=true}i.stateChanged(function(u){switch(u.newState){case jQuery.signalR.connectionState.connecting:h.donkyLogging.debugLog("The server is connecting");l=d.starting;break;case jQuery.signalR.connectionState.connected:h.donkyLogging.debugLog("The server is connected");l=d.started;break;case jQuery.signalR.connectionState.reconnecting:h.donkyLogging.debugLog("The server is reconnecting");l=d.starting;break;case jQuery.signalR.connectionState.disconnected:h.donkyLogging.debugLog("The server is disconnected");l=d.stopped;break}});g=i.createHubProxy("NetworkHub");g.on("push",function(u){h.donkyLogging.debugLog("Push was called with notifications: "+JSON.stringify(u));if(!j){h._processServerNotifications(u);if(n){a._synchroniseOverSignalR()}else{a._synchronizeOverREST()}}else{h.donkyLogging.debugLog("Already doing a sync so binning off - will get it in the response from synchronise")}});k=true;a._startSignalR()}else{h.donkyLogging.warnLog("_signalR.init() called twice")}};b.prototype._isSignalRStarted=function(){return l===d.started};b.prototype._getSignalRState=function(){return l};b.prototype._useSignalR=function(t){n=t};b.prototype._usingSignalR=function(){return n};b.prototype._startSignalR=function(u){if(i!==null){var t=h.donkyData.get("accessDetails");switch(l){case d.initializing:case d.stopped:i.qs={access_token:t.accessToken};l=d.starting;i.start().done(function(){l=d.started;if(h._isFunction(u)){u()}a._synchroniseOverSignalR(function(v){h.publishLocalEvent({type:"SignalRStarted",data:{}});if(s!==undefined){h.donkyLogging.debugLog("syncWhenStartingCallback registered, calling ...");s(v);s=undefined}if(p===true){h.donkyLogging.debugLog("Entered the started state and found a stop request. stopping ...");p=false;a._stopSignalR(o);o=undefined}})}).fail(function(v){l=d.stopped;h.donkyLogging.warnLog("Connection error: "+v);a._synchronizeOverREST(function(){if(s!==undefined){h.donkyLogging.debugLog("syncWhenStartingCallback registered, calling ...");s();s=undefined}})});break;case d.started:if(h._isFunction(u)){u()}h.donkyLogging.warnLog("_startSignalR() called when already started");break;case d.starting:h.donkyLogging.warnLog("_startSignalR() called when starting");break;case d.stopping:h.donkyLogging.debugLog("_startSignalR() called when stopping - requesting a start when stopped");c=true;r=u;break;default:h.donkyLogging.errorLog("Unknown signalR status: "+l);break}}else{h.donkyLogging.warnLog("_startSignalR() called when not initialized")}};b.prototype._stopSignalR=function(t){if(i!==null){switch(l){case d.started:i.stop();l=d.stopped;h.publishLocalEvent({type:"SignalRStopped",data:{}});if(h._isFunction(t)){t()}if(c===true){h.donkyLogging.debugLog("Entered the stopped state and found a start request. starting ...");c=false;a._startSignalR(r);r=undefined}break;case d.stopped:h.donkyLogging.warnLog("_stopSignalR() called when already stopped");if(h._isFunction(t)){t()}break;case d.stopping:h.donkyLogging.warnLog("_stopSignalR() called when already stopping");if(h._isFunction(t)){t()}break;case d.starting:case d.initializing:h.donkyLogging.debugLog("_stopSignalR() called when initializing / starting  - requesting a stop when started");p=true;o=t;break;default:h.donkyLogging.errorLog("Unknown signalR status: "+l);break}}else{h.donkyLogging.warnLog("_stopSignalR() called when not initialized")}};b.prototype._synchroniseOverSignalR=function(u){if(j){h.donkyLogging.warnLog("synchronize called when already synchronizing");if(h._isFunction(u)){u({succeeded:false})}return}if(l==d.started){var t=h._getClientNotificationsToExecute();h.donkyLogging.debugLog("invoking synchronise: "+JSON.stringify(t));j=true;h._processPendingClientNotifications(t);g.invoke("synchronise",t).done(function(v){j=false;h.donkyLogging.infoLog("Call to synchronise succeeded, result was: "+JSON.stringify(v));h._processServerNotifications(v.serverNotifications);if(h._isArray(v.failedClientNotifications)&&v.failedClientNotifications.length>0){h.donkyLogging.warnLog("Exchange returned some failed client notifications: "+JSON.stringify(v.failedClientNotifications))}h.donkyData.remove("ExecutingClientNotifications");if(h._isPendingNotifications()){h.donkyLogging.infoLog("_processServerNotifications() generated some pending client notifications, sending now ...");a._synchroniseOverSignalR(u)}else{if(h._isFunction(u)){u({succeeded:true,response:v})}}}).fail(function(v){j=false;l=d.stopped;h.donkyLogging.errorLog("Call to synchronise failed: "+v);if(h._isFunction(u)){u({succeeded:false})}})}else{h.donkyLogging.warnLog("signalR not initialized so can't synchronise over this channel")}};b.prototype._synchronizeOverREST=function(u){if(j){h.donkyLogging.warnLog("synchronize called when already synchronizing");if(h._isFunction(u)){u({succeeded:false})}return}var t={clientNotifications:h._getClientNotificationsToExecute(),isBackground:true};j=true;h._processPendingClientNotifications(t.clientNotifications);this.ajax(t,"POST",this.api.secure,"notification/synchronise",function(v){j=false;if(v.succeeded){h.donkyLogging.debugLog("Call to synchronise succeeded, result was: "+JSON.stringify(v));h._processServerNotifications(v.response.serverNotifications);if(h._isArray(v.response.failedClientNotifications)&&v.response.failedClientNotifications.length>0){h.donkyLogging.warnLog("Exchange returnewd some failed client notifications: "+JSON.stringify(v.response.failedClientNotifications))}h.donkyData.remove("ExecutingClientNotifications");if(h._isPendingNotifications()){a._synchronizeOverREST(u)}else{if(h._isFunction(u)){u(v)}}}else{j=false;h.donkyLogging.errorLog("Call to synchronise failed, result was: "+JSON.stringify(v));if(h._isFunction(u)){u(v)}}})};b.prototype.synchronise=function(x){try{h.donkyData.set("lastSynchroniseTime",new Date().valueOf());var w=h.donkyData.get("configuration");var v=parseInt(w.configurationItems.SignalRMaxMessageSizeBytes);var t=h._getPendingNotificationsLength();if(t<v&&n){if(l==d.initializing||l==d.starting){s=x}else{if(l==d.started){a._synchroniseOverSignalR(x)}else{a._synchronizeOverREST(x)}}}else{a._synchronizeOverREST(x)}}catch(u){h.donkyLogging.errorLog("caught exception in synchronise() : "+u);if(h._isFunction(x)){x({succeeded:false})}}};b.prototype.getServerNotification=function(v,t){try{if(!h._isFunction(t)){throw new Error("resultHandler not supplied")}this.ajax(null,"GET",this.api.secure,"notification/"+v,function(w){if(w.succeeded){t(w.response)}else{h.donkyLogging.warnLog("Failed to get Server Notification: "+v);t(null)}})}catch(u){h.donkyLogging.errorLog("caught exception in getServerNotification() : "+u);t(null)}};b.prototype._getAuthorizationHeader=function(){var t=h.donkyData.get("accessDetails");return t!==null?t.tokenType+" "+t.accessToken:""};return b})();;/*!
 * DonkyCore JavaScript Library
 *
 * Copyright (C) Donky Networks Ltd. All rights reserved.
 *
 */
var DonkyCore=(function(){var o;var h="https://cdn.dnky.co/sdk/latest-modular/";var n=[];var i=[];var l=[];var k=[];var c={};var g={uninitialised:0,initialising:1,initialised:2,uninitialising:3,failed:4,initialisingPendingRegistration:5};var f=g.uninitialised;var b=100;var a=[];var e={newDeviceWarning:true,newDeviceTitle:"New Device ?",newDeviceBody:"A new device has been registered against your account; if you did not register this device please let us know immediately",};function p(){if(typeof o!=="undefined"){return o}o=this;o.registerModule({name:"donkyCore",version:o.version()});p.prototype.donkyData=new DonkyData({donkyCore:o});p.prototype.donkyLogging=new DonkyLogging({donkyCore:o});p.prototype.donkyNetwork=new DonkyNetwork({donkyCore:o});p.prototype.donkyAccount=new DonkyAccount({donkyCore:o});o.subscribeToDonkyNotifications({name:"donkyCore",version:o.version()},[{notificationType:"TransmitDebugLog",handler:function(q){o.donkyLogging.debugLog("TransmitDebugLog : "+JSON.stringify(q));o._queueAcknowledgement(q,"Delivered");o.submitLog()}},{notificationType:"NewDeviceAddedToUser",handler:function(r){o.donkyLogging.debugLog("NewDeviceAddedToUser : "+JSON.stringify(r));o.publishLocalEvent({type:"NewDeviceAddedToUser",data:r});if(e.newDeviceWarning){var q=o.getService("donkyPushLogic");if(q!==null){q.queueCustomPopup("newDeviceWarning",e.newDeviceTitle,e.newDeviceBody)}}}}],true);o.subscribeToLocalEvent("DonkyInitialised",function(q){f=g.initialised;o._updateClientInfoIfChanged()});return o}p.prototype._dateDiff=function(q,s){var r=s-q;if(isNaN(r)){return NaN}return{milliSeconds:r,seconds:Math.floor(r/1000),minutes:Math.floor(r/(1000*60)),hours:Math.floor(r/(1000*60*60)),days:Math.floor(r/(1000*60*60*24))}};p.prototype._versionCompare=function(w,v){var u=w.split("."),s=v.split(".");function t(y){return(/^\d+$/).test(y)}var r=true;o._each(u,function(x,y){r=t(y);if(r){u[x]=parseInt(y)}return r});o._each(s,function(x,y){r=t(y);if(r){s[x]=parseInt(y)}return r});if(!r){return NaN}while(u.length<s.length){u.push(0)}while(s.length<u.length){s.push(0)}for(var q=0;q<u.length;++q){if(s.length==q){return 1}if(u[q]==s[q]){continue}else{if(u[q]>s[q]){return 1}else{return -1}}}if(u.length!=s.length){return -1}return 0};p.prototype._isPendingNotifications=function(){var q=o.donkyData.get("PendingClientNotifications");return q!==null&&q!==undefined&&o._isArray(q)&&q.length>0};p.prototype._getPendingNotificationsLength=function(){var r=o.donkyData.getString("PendingClientNotifications");var q=0;if(r!==null&&r!==undefined){q=r.length}return q};p.prototype._getClientNotificationsToExecute=function(){var q=o.donkyData.get("PendingClientNotifications");var s=o.donkyData.get("ExecutingClientNotifications");var r=[];if(s!==null){r=s}if(q!==null){r=r.concat(q)}o.donkyData.set("ExecutingClientNotifications",r);o.donkyData.remove("PendingClientNotifications");o.donkyLogging.infoLog("_getClientNotificationsToExecute() : "+JSON.stringify(r));return r};p.prototype._queueAcknowledgement=function(s,q){var r={type:"Acknowledgement",acknowledgementDetail:{serverNotificationId:s.id,result:q,sentTime:s.createdOn,type:s.type,customNotificationType:s.type==="Custom"?s.data.customType:undefined}};o.queueClientNotifications(r)};p.prototype._batchifyServerNotifications=function(q){var r={customNotifications:{},donkyNotifications:{},recentlySeenNotifications:[]};o._each(q,function(s,t){if(o.findNotificationInRecentCache(t.id)){r.recentlySeenNotifications.push(t)}else{if(t.type=="Custom"){if(!o._isArray(r.customNotifications[t.data.customType])){r.customNotifications[t.data.customType]=[]}r.customNotifications[t.data.customType].push(t)}else{if(!o._isArray(r.donkyNotifications[t.type])){r.donkyNotifications[t.type]=[]}r.donkyNotifications[t.type].push(t)}}});return r};p.prototype._isAutoAcknowledge=function(s,q){var r=false;o._each(s,function(t,u){if(u.autoAcknowledge===true&&u.notificationType===q){r=true}});return r};p.prototype._processServerNotificationBatch=function(q,r,t){var s=false;o._each(t,function(u,v){if(v.notificationType==r&&!v.removed){try{if(o._isFunction(v.batchHandler)){v.batchHandler(q);s=true}else{if(o._isFunction(v.handler)){o._each(q,function(x,y){v.handler(y)});s=true}else{o.donkyLogging.warnLog("No handler on subscriber interface")}}}catch(w){o.donkyLogging.errorLog("Caught exception processing server notifications")}}});if(!s){o.donkyLogging.warnLog("Message batch: "+r+" not handled")}return s};p.prototype._processServerNotifications=function(q){var t,s;var r=o._batchifyServerNotifications(q);o._each(r.donkyNotifications,function(v,u){s=o._isAutoAcknowledge(n,v);t=o._processServerNotificationBatch(u,v,n);if(!t||s){o._each(u,function(w,x){o._queueAcknowledgement(x,t?"Delivered":"DeliveredNoSubscription")})}o._each(u,function(w,x){o.addNotificationToRecentCache(x.id)})});o._each(r.customNotifications,function(v,u){t=o._processServerNotificationBatch(u,v,i);o._each(u,function(w,x){o._queueAcknowledgement(x,"Delivered");o.addNotificationToRecentCache(x.id)})});o._each(r.recentlySeenNotifications,function(u,v){o._queueAcknowledgement(v,"Delivered")})};p.prototype.addNotificationToRecentCache=function(r){o.donkyLogging.infoLog("addNotificationToRecentCache("+r+");");a.push(r);if(a.length>b){var q=a.length-b;a.splice(0,q)}};p.prototype.findNotificationInRecentCache=function(r){var q=false;o._each(a,function(s,t){if(t===r){q=true}return !q});o.donkyLogging.infoLog("findNotificationInRecentCache("+r+") : "+(q?"Found":"Not found"));return q};p.prototype._processPendingClientNotifications=function(q){o._each(q,function(r,s){o._each(l,function(t,u){if(u.notificationType==s.type&&!u.removed){u.handler(s)}})})};function m(t){var s=true;if(t.content.data!==null&&t.content.data!==undefined){var v=o.donkyData.get("configuration");var q=parseInt(v.configurationItems.CustomContentMaxSizeBytes);var u=parseInt(v.configurationItems.SignalRMaxMessageSizeBytes);var r=JSON.stringify(t.content.data).length;if(r>u){s=false;o.donkyLogging.debugLog("ContentNotification size too large ("+r+"): max size = "+q)}else{o.donkyLogging.debugLog("ContentNotification size ok ("+r+"): max size = "+q)}}return s}p.prototype.queueContentNotifications=function(s){try{var r=[];var q=[];if(o._isArray(s)){o._each(s,function(u,v){if(m(v)){r.push({type:"SendContent",definition:v})}else{q.push({type:"SendContent",definition:v})}})}else{if(m(s)){r.push({type:"SendContent",definition:s})}else{q.push({type:"SendContent",definition:s})}}if(r.length>0){o.queueClientNotifications(r)}if(q.length>0){return{succeeded:false,failedClientNotifications:q,reason:"The following notifications are too large and have not been processsed"}}else{return{succeeded:true}}}catch(t){o.donkyLogging.errorLog("caught exception in queueCustomNotifications() : "+t)}};p.prototype.sendContentNotifications=function(q,s){try{var r=o.queueContentNotifications(q);if(!r.succeeded){o.donkyLogging.debugLog(r.failedClientNotifications.length+" invalid content notification(s)")}o.donkyNetwork.synchronise(function(u){if(o._isFunction(s)){if(!r.succeeded){u.succeeded=false;o._each(r.failedClientNotifications,function(v,w){u.response.failedClientNotifications.push({notification:{type:"SendContent"},validationFailures:[{property:"data",details:"The data is too large ",failureCode:12004,failureKey:"CustomDataTooLong",notification:w}],failureReason:"ValidationFailure"})})}s(u)}})}catch(t){o.donkyLogging.errorLog("caught exception in sendContentNotifications() : "+t)}};p.prototype.createContentNotificationForSpecifiedUsers=function(u,t,q){try{var s={audience:{type:"SpecifiedUsers",users:[]},content:{type:"Custom",customType:t,data:q},filters:[]};if(o._isArray(u)){o._each(u,function(w,v){s.audience.users.push({userId:v})})}else{s.audience.users.push({userId:u})}return s}catch(r){o.donkyLogging.errorLog("caught exception in formatContentNotification() : "+r);return null}};p.prototype.queueClientNotifications=function(r){try{o.donkyLogging.infoLog("queueClientNotification: "+JSON.stringify(r));var q=o.donkyData.get("PendingClientNotifications");if(q===null||q===undefined){q=[]}if(o._isArray(r)){o._each(r,function(t,u){q.push(u)})}else{q.push(r)}o.donkyData.set("PendingClientNotifications",q)}catch(s){o.donkyLogging.errorLog("caught exception in queueClientNotifications() : "+s)}};p.prototype._compareDictionaries=function(r,q){var s=true;if(r===undefined&&q===undefined){}else{if(r!==undefined&&q!==undefined){if(Object.keys(r).length==Object.keys(q).length){o._each(r,function(t,u){if(u!=q[t]){s=false}return s})}else{s=false}}else{if(r!==undefined||q!==undefined){s=false}}}return s};p.prototype._updateClientInfoIfChanged=function(){var q=o.donkyAccount._getClient();if(q!==null&&q!==undefined){if(!o._compareDictionaries(q.moduleVersions,o._moduleVersions)){o.donkyLogging.debugLog("moduleVersions different - updating network ...");q.moduleVersions=o._moduleVersions;q.currentLocalTime=new Date().toISOString();o.donkyAccount._updateClient(q,function(r){if(r.succeeded){o.donkyLogging.debugLog("moduleVersions succesfully updated")}else{o.donkyLogging.errorLog("Failed to update moduleVersions")}})}}};p.prototype._hasUserDetailsChanged=function(r){var q=o.donkyAccount.getRegistrationDetails();return(r.id!=q.userDetails.id||r.displayName!=q.userDetails.displayName||r.firstName!=q.userDetails.firstName||r.lastName!=q.userDetails.lastName||r.emailAddress!=q.userDetails.emailAddress||r.countryCode!=q.userDetails.countryCode||r.mobileNumber!=q.userDetails.mobileNumber||!o._compareDictionaries(r.additionalProperties,q.userDetails.additionalProperties))};p.prototype._hasDeviceDetailsChanged=function(q){var r=o.donkyAccount.getRegistrationDetails();return(q.type!=r.deviceDetails.type||q.name!=r.deviceDetails.name||!o._compareDictionaries(q.additionalProperties,r.deviceDetails.additionalProperties))};p.prototype._initialize=function(r){if(r.userDetails!==undefined||r.deviceDetails!==undefined){var q={};if(r.deviceDetails!==undefined&&o._hasDeviceDetailsChanged(r.deviceDetails)){q.deviceDetails=r.deviceDetails}if(r.userDetails!==undefined&&o._hasUserDetailsChanged(r.userDetails)){q.userDetails=r.userDetails}if(q.deviceDetails!==undefined||q.userDetails!==undefined){o.donkyAccount.updateRegistrationDetails(q,function(s){if(s.succeeded){o.publishLocalEvent({type:"DonkyInitialised",data:{}});r.resultHandler(s)}else{if(s.statusCode===400){var t=s.response.filter(function(u){return u.failureKey==="UserIdAlreadyTaken"});if(t.length===1){o.donkyLogging.warnLog("UserIdAlreadyTaken");o.donkyAccount._register(r,function(u){if(u.succeeded){o.publishLocalEvent({type:"DonkyInitialised",data:{}})}else{f=g.failed}r.resultHandler(u)})}}else{f=g.failed;r.resultHandler(s)}}})}else{o.publishLocalEvent({type:"DonkyInitialised",data:{}});r.resultHandler({succeeded:true})}}else{o.publishLocalEvent({type:"DonkyInitialised",data:{}});r.resultHandler({succeeded:true})}};p.prototype.initialise=function(r){o.donkyData.set("usingAuth",false);var s;if(r===undefined||r===null){throw new Error("no options specified")}if(r.newDeviceWarning!==undefined){e.newDeviceWarning=r.newDeviceWarning}if(r.newDeviceTitle!==undefined){e.newDeviceTitle=r.newDeviceTitle}if(r.newDeviceBody!==undefined){e.newDeviceBody=r.newDeviceBody}if(r.logLevel!==undefined){o.donkyLogging._setLogLevel(r.logLevel)}if(!o._isFunction(r.resultHandler)){o.donkyLogging.warnLog("No ResultHandler specified");throw new Error("resultHandler not specified")}if(f===g.initialising){s="initialise() called twice";o.donkyLogging.warnLog(s);return(r.resultHandler({succeeded:false,response:s}))}var q=o.donkyAccount._getBrowserInfo();if(q.name==="MSIE"&&q.version<10){s="Unsupported version of IE: "+q.version+" (must be >=10)";o.donkyLogging.warnLog(s);return(r.resultHandler({succeeded:false,response:s}))}if(r.apiKey===undefined){s="No apiKey specified";o.donkyLogging.warnLog(s);return(r.resultHandler({succeeded:false,response:s}))}f=g.initialising;var t=o.donkyData.get("apiKey");if(t!==null&&t!==r.apiKey){o.donkyData.remove("networkId")}if(r.useSignalR===false||window.cordova){o.donkyNetwork._useSignalR(false)}else{o.donkyNetwork._useSignalR(true)}o.donkyData.set("apiKey",r.apiKey);o.donkyData.set("environment",r.environment!==undefined?r.environment:"");o.donkyData.set("scheme",r.scheme!==undefined?r.scheme:"https://");if(!o.donkyAccount.isRegistered()){if(r.autoRegister!==false){o.donkyAccount._register(r,function(u){if(u.succeeded){o.publishLocalEvent({type:"DonkyInitialised",data:{}})}else{f=g.failed}r.resultHandler(u)})}else{f=g.initialisingPendingRegistration;r.resultHandler({succeeded:true})}}else{o.donkyAccount._checkToken(function(u){if(u.succeeded){o._initialize(r)}else{r.resultHandler(u)}},true)}};p.prototype.uninitialise=function(s){function q(t){f=g.uninitialised;o.publishLocalEvent({type:"DonkyUninitialised",data:{}});t({succeeded:true})}function r(t){if(o.donkyAccount.isPushEnabled()===true){o.donkyAccount.deletePushConfiguration(function(){q(t)})}else{q(t)}}if(f===g.initialised){f=g.uninitialising;if(o.donkyNetwork._usingSignalR()){o.donkyNetwork._stopSignalR(function(){r(s)})}else{r(s)}}else{s({succeeded:false,message:"SDK is not Initialised"})}};p.prototype.isInitialised=function(){return f===g.initialised};p.prototype.initialisationStatus=g;p.prototype.getInitialisationStatus=function(){return f};p.prototype.authenticatedInitialise=function(s){o.donkyData.set("usingAuth",true);var t;if(s===undefined||s===null){throw new Error("no options specified")}if(s.logLevel!==undefined){o.donkyLogging._setLogLevel(s.logLevel)}if(!o._isFunction(s.resultHandler)){o.donkyLogging.warnLog("No ResultHandler specified");throw new Error("resultHandler not specified")}if(!o._isFunction(s.onAuthenticationChallenge)){o.donkyLogging.warnLog("No onAuthenticationChallenge ahndler specified");throw new Error("onAuthenticationChallenge not specified")}o.donkyAccount.onAuthenticationChallenge=s.onAuthenticationChallenge;if(f===g.initialising){t="initialise() called twice";o.donkyLogging.warnLog(t);return(s.resultHandler({succeeded:false,response:t}))}var r=o.donkyAccount._getBrowserInfo();if(r.name==="MSIE"&&r.version<10){t="Unsupported version of IE: "+r.version+" (must be >=10)";o.donkyLogging.warnLog(t);return(s.resultHandler({succeeded:false,response:t}))}if(s.apiKey===undefined){t="No apiKey specified";o.donkyLogging.warnLog(t);return(s.resultHandler({succeeded:false,response:t}))}f=g.initialising;var u=o.donkyData.get("apiKey");if(u!==null&&u!==s.apiKey){o.donkyData.remove("networkId")}o.donkyData.set("apiKey",s.apiKey);o.donkyData.set("environment",s.environment!==undefined?s.environment:"");o.donkyData.set("scheme",s.scheme!==undefined?s.scheme:"https://");if(!o.donkyAccount.isRegistered()){if(s.autoRegister!==false){var q={userDetails:s.userDetails,deviceDetails:s.deviceDetails};o.donkyAccount._registerUsingAuthentication(q,function(v){if(v.succeeded){o.publishLocalEvent({type:"DonkyInitialised",data:{}})}else{f=g.failed}s.resultHandler(v)})}else{f=g.initialisingPendingRegistration;s.resultHandler({succeeded:true})}}else{o.donkyAccount._checkToken(function(v){if(v.succeeded){o.publishLocalEvent({type:"DonkyInitialised",data:{}})}s.resultHandler(v)},true)}};function d(r,t,q,s){if(o._isArray(t)){o._each(t,function(u,v){v.autoAcknowledge=s===undefined?true:s;q.push(v)})}else{t.autoAcknowledge=s===undefined?true:s;q.push(t)}o.registerModule(r)}function j(r,t,q){var s=o._isArray(t)?t:[t];o._each(s,function(u,x){for(var v=q.length-1;v>=0;v--){var w=q[v];if(w.notificationType===x.notificationType&&(w.handler===x.handler||w.batchHandler===x.batchHandler)){w.removed=true}}})}p.prototype.subscribeToDonkyNotifications=function(q,t,s){try{d(q,t,n,s)}catch(r){o.donkyLogging.errorLog("caught exception in subscribeToDonkyNotifications() : "+r)}};p.prototype.subscribeToContentNotifications=function(q,s){try{d(q,s,i)}catch(r){o.donkyLogging.errorLog("caught exception in subscribeToContentNotifications() : "+r)}};p.prototype.unsubscribeFromContentNotifications=function(q,s){try{j(q,s,i)}catch(r){o.donkyLogging.errorLog("caught exception in unsubscribeFromContentNotifications() : "+r)}};p.prototype.unsubscribeFromDonkyNotifications=function(q,s){try{j(q,s,n)}catch(r){o.donkyLogging.errorLog("caught exception in unsubscribeFromDonkyNotifications() : "+r)}};p.prototype.subscribeToOutboundNotifications=function(q,s){try{if(o._isArray(s)){o._each(s,function(t,u){l.push(u)})}else{l.push(s)}o.registerModule(q)}catch(r){o.donkyLogging.errorLog("caught exception in subscribeToOutboundNotifications() : "+r)}};p.prototype.unsubscribeFromOutboundNotifications=function(q,s){try{j(q,s,l)}catch(r){o.donkyLogging.errorLog("caught exception in unsubscribeFromOutboundNotifications() : "+r)}};p.prototype.publishLocalEvent=function(q){try{if(window.donkyDeviceOverrides){if(q.type==="DonkyInitialised"){window.DonkyInitialised=true}else{if(q.type==="DonkyUninitialised"){window.DonkyInitialised=false}}}var s=false;o._each(k,function(u,t){if(t.eventType==q.type&&t.removed!==true){try{t.handler(q);s=true}catch(v){o.donkyLogging.warnLog("caught exception in local event handler() : "+v)}}});if(!s){}}catch(r){o.donkyLogging.warnLog("caught exception in publishLocalEvent() : "+r)}};p.prototype.subscribeToLocalEvent=function(q,r){try{k.push({eventType:q,handler:r})}catch(s){o.donkyLogging.errorLog("caught exception in subscribeToLocalEvent() : "+s)}};p.prototype.unsubscribeFromLocalEvent=function(r,t){try{var v=false;for(var q=k.length-1;q>=0;q--){var s=k[q];if(s.eventType===r&&s.handler===t){s.removed=true;v=true;o.donkyLogging.debugLog("unsubscribeToEvent() succeeded")}}if(!v){o.donkyLogging.warnLog("unsubscribeToEvent() failed")}}catch(u){o.donkyLogging.errorLog("caught exception in unsubscribeFromLocalEvent() : "+u)}};p.prototype.formatAssetUrl=function(r){try{var s=o.donkyData.get("configuration");return s.configurationItems.AssetDownloadUrlFormat.replace("{0}",r)}catch(q){o.donkyLogging.errorLog("caught exception in formatAssetUrl() : "+q);return null}};p.prototype.formatAssetDownloadUrl=function(t,r){try{var u=o.donkyData.get("configuration");var q=u.configurationItems.AssetDownloadNamedFileUrlFormat.replace("{0}",t);return q.replace("{1}",r)}catch(s){o.donkyLogging.errorLog("caught exception in formatAssetDownloadUrl() : "+s);return null}};p.prototype.registerService=function(r,q){try{if(c[r]!==undefined){o.donkyLogging.warnLog("registerService("+r+") - overwriting an existing instance")}else{o.donkyLogging.debugLog("registerService("+r+")")}c[r]=q}catch(s){o.donkyLogging.errorLog("caught exception in registerService() : "+s)}};p.prototype.getService=function(q){try{if(c[q]!==undefined){o.donkyLogging.debugLog("getService("+q+")");return c[q]}else{o.donkyLogging.debugLog("getService("+q+") - service not available");return null}}catch(r){o.donkyLogging.errorLog("caught exception in getService() : "+r);return null}};p.prototype.unregisterService=function(q){try{if(c[q]!==undefined){o.donkyLogging.debugLog("unregisterService("+q+")");delete c[q]}else{o.donkyLogging.warnLog("unregisterService("+q+") - service not available")}}catch(r){o.donkyLogging.errorLog("caught exception in unregisterService() : "+r)}};p.prototype._moduleVersions={};p.prototype.registerModule=function(q){try{if(o._moduleVersions[q.name]!==undefined){if(o._moduleVersions[q.name]!=q.version){o._moduleVersions[q.name]=q.version}}else{o._moduleVersions[q.name]=q.version}}catch(r){o.donkyLogging.errorLog("caught exception in registerModule() : "+r)}};p.prototype.isModuleRegistered=function(q,r){try{var t=false;if(o._moduleVersions[q]!==undefined){if(r===undefined){t=true}else{t=o._versionCompare(r,o._moduleVersions[q])<=0}}return t}catch(s){o.donkyLogging.errorLog("caught exception in isModuleRegistered() : "+s);return false}};p.prototype.getRegisteredModules=function(){try{var q=[];o._each(o._moduleVersions,function(t,s){q.push({name:t,version:s})});return q}catch(r){o.donkyLogging.errorLog("caught exception in getRegisteredModules() : "+r);return null}};p.prototype._submitLog=function(u,t){var r=o.donkyData.get("lastSubmitLogTimestamp");if(r!==null){var q=o._dateDiff(new Date(r),new Date());if(q.seconds<30){o.donkyLogging.warnLog("_submitLog() submitting too frequently");if(o._isFunction(t)){t({succeeded:false})}return}}if(o.donkyAccount.isRegistered()&&!o.donkyAccount._isSuspended()){var s=o.donkyLogging.getLog();if(s!==""){o.donkyNetwork.ajax({data:s,submissionReason:u},"POST",o.donkyNetwork.api.secure,"debuglog",function(v){o.donkyData.set("lastSubmitLogTimestamp",new Date().toISOString());if(v.succeeded){o.donkyLogging.clearLog();if(!v.response.alwaysSubmitErrors){o.donkyLogging.debugLog("_submitLog() spamming - network has set alwaysSubmitErrors to false");var w=o.donkyData.get("configuration");if(w!==null&&w!==undefined){if(w.configurationItems!==undefined){w.configurationItems.AlwaysSubmitErrors="false";o.donkyData.set("configuration",w);o.donkyLogging.debugLog("updated alwaysSubmitErrors to false")}}}if(o._isFunction(t)){t(v)}}})}else{if(o._isFunction(t)){t({succeeded:true})}}}else{if(o._isFunction(t)){t({succeeded:false})}}};p.prototype.submitLog=function(r){try{o._submitLog("ManualRequest",r)}catch(q){o.donkyLogging.errorLog("caught exception in submitLog() : "+q)}};p.prototype.installDir=h;p.prototype.version=function(){return"2.2.3.3"};p.prototype._extend=function(){for(var r=1;r<arguments.length;r++){for(var q in arguments[r]){if(arguments[r].hasOwnProperty(q)){arguments[0][q]=arguments[r][q]}}}return arguments[0]};p.prototype._isObject=function(q){return q!==null&&typeof q==="object"};p.prototype._isFunction=function(q){var r={};return q&&r.toString.call(q)==="[object Function]"};p.prototype._isArray=function(q){return Object.prototype.toString.call(q)==="[object Array]"};p.prototype._each=function(u,v){var t,r=0,s=u.length,q=o._isArray(u);if(q){for(;r<s;r++){t=v.call(u[r],r,u[r]);if(t===false){break}}}else{for(r in u){t=v.call(u[r],r,u[r]);if(t===false){break}}}return u};p.prototype.getiOSButtonCategories=function(r,q){var s=o.donkyData.get("configuration");return s.configurationSets.ButtonSets.buttonSets};p.prototype._uuid=function(){var r=new Date().getTime();var q="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var s=(r+Math.random()*16)%16|0;r=Math.floor(r/16);return(t=="x"?s:(s&3|8)).toString(16)});return q};return p})();(function(){var a=function(){return new DonkyCore()};if(typeof define==="function"&&define.amd){define("donkyCore",["donkyData","donkyAccount","donkyLogging","donkyNetwork"],a)}else{window.donkyCore=a()}}());;/*!
 * DonkyMessagingCommon JavaScript Library
 *
 * Copyright (C) Donky Networks Ltd. All rights reserved.
 *
 */
(function(){var a=function(d){if(d===undefined){throw new Error("Missing donkyCore")}var c;var e={simplePush:0,rich:1,custom:2};function b(){d.donkyLogging.infoLog("Constructing DonkyMessagingCommon")}b.prototype={markMessageReceived:function(h,g){var f={type:"MessageReceived",senderInternalUserId:h.data.senderInternalUserId,messageId:h.data.messageId,conversationId:h.data.conversationId,senderMessageId:h.data.senderMessageId,receivedExpired:g,messageType:h.data.messageType,messageScope:h.data.messageScope,sentTimestamp:h.data.sentTimestamp,contextItems:h.data.contextItems,acknowledgementDetail:{serverNotificationId:h.id,result:"Delivered",sentTime:h.createdOn,type:h.type}};d.queueClientNotifications(f)},markMessageRead:function(g){var h=d._dateDiff(new Date(g.receivedTimestamp),new Date());var f={type:"MessageRead",senderInternalUserId:g.senderInternalUserId,messageId:g.messageId,senderMessageId:g.senderMessageId,messageType:g.messageType,messageScope:g.messageScope,sentTimestamp:g.sentTimestamp,contextItems:g.contextItems,timeToReadSeconds:h.seconds};d.queueClientNotifications(f);d.donkyNetwork.synchronise()},markMessageDeleted:function(f,h){var g={type:"MessageDeleted",messageId:f};d.queueClientNotifications(g);if(h===true){d.donkyNetwork.synchronise()}},setBadgeCount:function(g,h){var f={type:"SetBadgeCount",badgeCount:g};d.queueClientNotifications(f);if(h===true){d.donkyNetwork.synchronise()}},markMessageShared:function(h,g){var f={type:"MessageShared",messageId:h.messageId,messageType:h.messageType,messageScope:h.messageScope,originalMessageSentTimestamp:h.sentTimestamp,sharedTo:g,sharedTimestamp:new Date().toISOString(),contextItems:h.contextItems};d.queueClientNotifications(f);d.donkyNetwork.synchronise()},isExpired:function(h){var g=false;if(h!==null&&h!==undefined){var f=new Date(h).valueOf();var i=new Date().valueOf();if(i>f){g=true}}return g},messageTypes:e};c=new b();return c};if(typeof define==="function"&&define.amd){define("donkyMessagingCommon",["donkyCore"],function(b){return a(b)})}else{window.donkyMessagingCommon=a(window.donkyCore)}}());;/*!
 * DonkyLocationServicesLogic JavaScript Library
 *
 * Copyright (C) Donky Networks Ltd. All rights reserved.
 *
 * ServerNotification - cant link to it, but type is LocationRequest.  Payload has a sendToNetworkProfileId property
 * 
 */
(function(){var a=function(g){if(g===undefined){throw new Error("Missing donkyCore")}var c;var h={autoRespondToLocationRequest:false,reportLocationTimeInterval:60};function e(i,k){var j={type:"LocationUpdate",timestamp:new Date().toISOString(),location:{latitude:i.latitude,longitude:i.longitude}};if(k){j.notifyUser={networkProfileId:k}}g.queueClientNotifications(j)}function b(i){if(h.autoRespondToLocationRequest){c.getCurrentPosition(function(k){g._each(i,function(l,m){e(k.coords,m.data.sendToNetworkProfileId)});g.donkyNetwork.synchronise()},function(k){g.donkyLogging.errorLog("getCurrentPosition failed: "+JSON.stringify(k))})}else{var j=[];g._each(i,function(k,l){j.push(l.data.sendToNetworkProfileId)});g.publishLocalEvent({type:"LocationRequested",data:j})}}function d(i){g._each(i,function(j,k){g.publishLocalEvent({type:"UserLocation",data:k.data})})}function f(){g.subscribeToDonkyNotifications({name:"DonkyLocationServicesLogic",version:"1.0.0.0",},[{notificationType:"LocationRequest",batchHandler:b},{notificationType:"UserLocation",batchHandler:d},],true)}f.prototype={getCurrentPosition:function(i,j,k){navigator.geolocation.getCurrentPosition(function(l){e(l.coords);i(l)},function(l){j(l)},k)},startLocationUpdates:function(l,i,j,k){c.getCurrentPosition(i,j,k);return setInterval(function(){c.getCurrentPosition(i,j,k)},l*1000)},stopLocationUpdates:function(i){clearInterval(i)},requestUserLocation:function(k,i){var j={type:"RequestLocation",targetUser:{userId:k},targetDeviceId:i};g.queueClientNotifications(j);g.donkyNetwork.synchronise()},sendLocationUpdate:function(i,j){if(j){g._each(j,function(k,l){e(i,l)})}else{e(i)}g.donkyNetwork.synchronise()},getAutoRespondToLocationRequest:function(){return h.autoRespondToLocationRequest},setAutoRespondToLocationRequest:function(i){h.autoRespondToLocationRequest=i},};c=new f();g.registerService("donkyLocationServicesLogic",c);return c};if(typeof define==="function"&&define.amd){define("donkyLocationServicesLogic",["donkyCore"],function(b){return a(b)})}else{window.donkyLocationServicesLogic=a(window.donkyCore)}}());;/*!
 * DonkyAssets JavaScript Library
 *
 * Copyright (C) Donky Networks Ltd. All rights reserved.
 *
 */
(function(){var a=function(i){if(i===undefined){throw new Error("Missing donkyCore")}var j;function d(l){var k=l.indexOf("base64,");if(k!==-1){return l.substring(k+7)}else{return null}}function b(m){var l=m.indexOf("base64,");var k=5;return m.substring(k,l-1)}function c(m){var n=window.atob(m);var k=n.length;var l=new Uint8Array(k);for(var o=0;o<k;o++){l[o]=n.charCodeAt(o)}return l.buffer}function e(q,l,m,s,r){var n=document.createElement("canvas");var t=n.getContext("2d");var k=document.createElement("canvas");var o=k.getContext("2d");var p=new Image();p.src=q;p.onload=function(){k.width=p.width;k.height=p.height;o.drawImage(p,0,0);n.width=m;n.height=s;t.drawImage(k,0,0,k.width,k.height,0,0,n.width,n.height);var v=n.toDataURL(l);var u=d(v);r(c(u))}}function h(p,o,l,r){var k=i.donkyData.get("environment");var m=i.donkyData.get("scheme");var q=new XMLHttpRequest();var n=m+k+i.donkyNetwork.api.secure+"asset";q.open("POST",n);q.setRequestHeader("AssetMetaData","{ 'MimeType': '"+o.mimeType+"', 'Type': '"+l+"'}");q.setRequestHeader("donkyClientSystemIdentifier","DonkyWebModularSdk");q.setRequestHeader("authorization",i.donkyNetwork._getAuthorizationHeader());q.setRequestHeader("apiKey",i.donkyData.get("apiKey"));q.addEventListener("load",function(s){if(s.target.status===200){var t=JSON.parse(s.target.responseText);o.assetId=t.assetId;r({succeeded:true,asset:o})}else{if(s.target.status===400){r({succeeded:false,response:JSON.parse(s.target.responseText)})}else{r({succeeded:false})}}},false);q.addEventListener("error",function(s){r({succeeded:false})},false);q.addEventListener("abort",function(s){r({succeeded:false})},false);q.addEventListener("progress",function(s){if(s.lengthComputable){var t=(s.loaded/s.total)*100;console.log("onprogress: "+t+" %")}},false);q.send(p)}function g(m,l,o){var n={name:m.name,mimeType:m.type,sizeInBytes:m.size,};var k=new FileReader();k.addEventListener("load",function(p){var q=p.target.result;h(q,n,l,o)});k.readAsArrayBuffer(m)}function f(){i.donkyLogging.infoLog("Constructing DonkyAssets");var k={name:"DonkyAssets",version:"2.0.0.0"};i.registerModule(k)}f.prototype={uploadMessageAsset:function(k,l){if(!i._isFunction(l)){throw new Error("callback not supplied")}g(k,"MessageAsset",l)},uploadMessageAssetFromDataUrl:function(p,l,q){if(!i._isFunction(q)){throw new Error("callback not supplied")}var o=d(p);var k=b(p);var n=c(o);var m={name:l,mimeType:k,sizeInBytes:n.byteLength,};h(n,m,"MessageAsset",q)},uploadAccountAvatar:function(l,n){var m="image/png";var k=new FileReader();k.addEventListener("load",function(o){var p=e(o.target.result,m,96,96,function(r){var q={name:"avatar.png",mimeType:m};h(r,q,"AccountAvatar",n)})});k.readAsDataURL(l)}};j=new f();return j};if(typeof define==="function"&&define.amd){define("donkyAssets",["donkyCore"],function(b){return a(b)})}else{window.donkyAssets=a(window.donkyCore)}}());;/*!
 * DonkAutomation JavaScript Library
 *
 * Copyright (C) Donky Networks Ltd. All rights reserved.
 *
 */
(function(){var a=function(d){if(d===undefined){throw new Error("Missing donkyCore")}var b;function c(){d.donkyLogging.infoLog("Constructing DonkyAutomation")}c.prototype={executeThirdPartyTrigger:function(e,f){d.queueClientNotifications({type:"ExecuteThirdPartyTriggers",triggerKey:e,timestamp:new Date().toISOString(),tiggerActionsExecuted:[],customData:f});d.donkyNetwork.synchronise()}};b=new c();return b};if(typeof define==="function"&&define.amd){define("donkyAutomation",["donkyCore"],function(b){return a(b)})}else{window.donkyAutomation=a(window.donkyCore)}}());;/*!
 * DonkyAudio JavaScript Library
 *
 * Copyright (C) Donky Networks Ltd. All rights reserved.
 *
 */
(function(){var a=function(e,d){if(e===undefined){throw new Error("Missing donkyCore")}if(d===undefined){throw new Error("Missing donkyMessagingCommon")}var f;var c={};function b(){e.donkyLogging.infoLog("Constructing DonkyAudio")}b.prototype={setSound:function(g,h){try{c[g]=new Audio(h)}catch(i){c[g]=null}},playSound:function(g){if(c[g]!==undefined&&c[g]!==null){try{c[g].play()}catch(h){}}}};f=new b();e.registerService("donkyAudio",f);return f};if(typeof define==="function"&&define.amd){define("donkyAudio",["donkyCore","donkyMessagingCommon"],function(c,b){return a(c,b)})}else{window.donkyAudio=a(window.donkyCore,window.donkyMessagingCommon)}}());;/*!
 * DonkyPushLogic JavaScript Library
 *
 * Copyright (C) Donky Networks Ltd. All rights reserved.
 *
 */
(function(){var a=function(e,d,h){if(e===undefined){throw new Error("Missing donkyCore")}if(d===undefined){throw new Error("Missing donkyMessagingCommon")}var c;var i={};var g={load:function(){var j=e.donkyData.get("pushMessages");if(j===null){j=[]}return j},save:function(j){e.donkyData.set("pushMessages",j)},removeAll:function(){e.donkyData.remove("pushMessages")},add:function(k){var j=this.load();e.donkyLogging.debugLog("_pushMessageManager.add("+JSON.stringify(k)+") : currentMessageCount = "+j.length);var l=this.findId(j,k.id);if(l==-1){j.push(k);this.save(j);return true}else{e.donkyLogging.warnLog("Already got this push Message: "+k.id);return false}},remove:function(l){e.donkyLogging.debugLog("_pushMessageManager.remove("+l+")");var j=this.load();var k=this.findId(j,l);if(k!==-1){j.splice(k,1);this.save(j)}else{e.donkyLogging.warnLog("Failed to find push Message")}},findObj:function(l){var j=this.load();var k=null;e._each(j,function(m,n){if(n.id==l){k=n}return k===null});return k},findId:function(j,l){var k=-1;e._each(j,function(m,n){if(n.id==l){k=m}return k==-1});return k},getNext:function(){var j=this.load();if(j.length>0){var k=j[0];if(k.displayed===undefined){k.displayed=new Date().valueOf();this.save(j)}return k}else{return null}},removeExpiredMessages:function(){var j=this.load();var l=0;for(var k=j.length-1;k>=0;k--){if(d.isExpired(j[k].data.expiryTimeStamp)){e.donkyLogging.infoLog("messageId "+j[k].data.messageId+" is expired, deleting");j.splice(k,1);l++}}if(l>0){this.save(j)}},removeMessagesByCreator:function(l){var j=this.load();var m=0;for(var k=j.length-1;k>=0;k--){if(j[k].creator!==undefined&&j[k].creator===l){j.splice(k,1);m++}}if(m>0){this.save(j)}}};function b(k,l){var j=[];e._each(k,function(m,o){var n=d.isExpired(o.data.expiryTimeStamp);if(!n){if(g.add(o)){j.push(o)}}else{e.donkyLogging.debugLog("Received expired message, binning off ...")}if(o.data.senderInternalUserId!==undefined){d.markMessageReceived(o,n)}});if(j.length>0&&l!==false){e.publishLocalEvent({type:"NewSimplePushMessagesReceived",data:j})}}function f(){g.removeExpiredMessages();e.subscribeToDonkyNotifications({name:"DonkyPushLogic",version:"2.1.0.0",},{notificationType:"SimplePushMessage",batchHandler:b},false);e.subscribeToLocalEvent("RegistrationChanged",function(j){g.removeAll()})}f.prototype={getNextSimplePush:function(){try{return g.getNext()}catch(j){e.donkyLogging.errorLog("caught exception in getNextSimplePush() : "+j)}return null},deleteMessage:function(j){g.remove(j)},setSimplePushResult:function(k,s){var n=g.findObj(k);if(n!==null){g.remove(k);var m=n.data;if(s!==""&&(n.creator===undefined||n.creator===null)){var q={};var l=e.donkyAccount._getOperatingSystem()!=="Web"?"Mobile":"Web";e._each(m.buttonSets,function(w,x){if(x.platform===l){q=x}});var p="";var v="Button1";switch(q.interactionType){case"OneButton":p=q.buttonSetActions[0].label;break;case"TwoButton":p=q.buttonSetActions[0].label+"|"+q.buttonSetActions[1].label;if(s==q.buttonSetActions[1].label){v="Button2"}break}var u=new Date(n.displayed);var j=new Date();var r=j.getTime()-u.getTime();var o=Math.floor(r/1000);var t={type:"InteractionResult",senderInternalUserId:m.senderInternalUserId,messageId:m.messageId,senderMessageId:m.senderMessageId,timeToInteractionSeconds:o,interactionTimestamp:new Date().toISOString(),interactionType:q.interactionType,buttonDescription:p,userAction:v,operatingSystem:e.donkyAccount._getOperatingSystem(),messageSentTimestamp:m.msgSentTimeStamp,contextItems:m.contextItems};e.queueClientNotifications(t);e.donkyNetwork.synchronise()}e.publishLocalEvent({type:"PushMessageDeleted",data:k})}else{e.donkyLogging.warnLog("setSimplePushResult("+k+", "+s+") - Coundn't find message in store")}},getMessageCount:function(){try{var j=g.load();return j.length}catch(k){e.donkyLogging.errorLog("caught exception in getMessageCounts() : "+k)}return null},getInteractiveButtons:function(m){var l=m.data;var k=[];if(e._isArray(l.buttonSets)&&l.buttonSets.length>0){var j=e.donkyAccount._getOperatingSystem()!=="Web"?"Mobile":"Web";e._each(l.buttonSets,function(n,o){if(o.platform===j){e._each(o.buttonSetActions,function(p,r){var q={buttonText:r.label,actionType:r.actionType==="ExternalUrl"?"Link":r.actionType,linkURL:r.data?r.data:undefined};k.push(q)})}})}return k},deleteMessagesByCreator:function(j){g.removeMessagesByCreator(j)},queueCustomPopup:function(k,q,o,l,s,r,p,n){var m={creator:k,id:e._uuid(),type:"SimplePushMessage",data:{messageType:"SimplePush",avatarAssetId:null,buttonSets:[],senderDisplayName:q,body:o,expiryTimeStamp:l},createdOn:new Date().toISOString()};var j=e.donkyAccount._getOperatingSystem()!=="Web"?"Mobile":"Web";if(s!==undefined){m.data.buttonSets=[{buttonSetId:null,platform:j,interactionType:"TwoButton",buttonSetActions:[{actionType:"Javascript",data:s!==null?btoa(s):null,label:p},{actionType:"Javascript",data:r!==null?btoa(r):null,label:n}]}]}b([m])},processPushMessage:function(k,j){b([k],j)}};c=new f();e.registerService("donkyPushLogic",c);return c};if(typeof define==="function"&&define.amd){define("donkyPushLogic",["donkyCore","donkyMessagingCommon","Mustache"],function(c,b,d){return a(c,b,d)})}else{window.donkyPushLogic=a(window.donkyCore,window.donkyMessagingCommon,window.Mustache)}}());;/*!
 * DonkyRichLogic JavaScript Library
 *
 * Copyright (C) Donky Networks Ltd. All rights reserved.
 *
 */
(function(){var a=function(i,h){if(i===undefined){throw new Error("Missing donkyCore")}if(h===undefined){throw new Error("Missing donkyMessagingCommon")}var k;var e={richMessageAvailabilityDays:30};var b={load:function(){var l=i.donkyData.get("richMessages");if(l===null){l=[]}return l},save:function(l){i.donkyData.set("richMessages",l)},removeAll:function(){i.donkyData.remove("richMessages")},add:function(n){var l=this.load();i.donkyLogging.debugLog("_richMessageManager.add("+JSON.stringify(n)+") : currentMessageCount = "+l.length);var m=this.findId(l,n.messageId);if(m==-1){l.push(n);this.save(l);return true}else{i.donkyLogging.warnLog("Already got this rich Message: "+n.messageId);return false}},remove:function(n){i.donkyLogging.debugLog("_richMessageManager.remove("+n+")");var l=this.load();var m=this.findId(l,n);if(m!==-1){l.splice(m,1);this.save(l)}else{i.donkyLogging.warnLog("Failed to find rich Message")}},removeMany:function(n){i.donkyLogging.debugLog("_richMessageManager.removeMany("+JSON.stringify(n)+")");var l=this.load();var o=0;var m=this;i._each(n,function(r,q){var p=m.findId(l,q);if(p!==-1){l.splice(p,1);o++}else{i.donkyLogging.warnLog("Failed to find rich Message")}});if(o>0){this.save(l)}},findObj:function(m){var l=this.load();var n=null;i._each(l,function(o,p){if(p.messageId==m){n=p}return n===null});return n},findId:function(l,m){var n=-1;i._each(l,function(o,p){if(p.messageId==m){n=o}return n==-1});return n},markAsRead:function(n){var l=this.load();var m=this.findId(l,n);if(m!==-1){l[m].isRead=true;this.save(l)}},markManyAsRead:function(o){var n=0;var l=this.load();var m=this;i._each(o,function(r,q){var p=m.findId(l,q);if(p!==-1&&l[p].isRead===false){l[p].isRead=true;n++}});if(n>0){this.save(l)}},getNextUnread:function(){var l=this.load();if(l.length>0){for(var m=0;m<l.length;m++){if(!l[m].isRead){return l[m]}}return null}else{return null}},isAvailable:function(o){var l=true;var n=new Date(o.sentTimestamp);var m=new Date();var p=i._dateDiff(n,m);if(!isNaN(p)){if(p.days>e.richMessageAvailabilityDays){l=false}}return l},isExpired:function(l){var m=false;if(h.isExpired(l.expiryTimeStamp)&&(l.expiredBody===null||l.expiredBody===undefined)){m=true}return m},getExpiryTimestamp:function(n){if(n.expiryTimeStamp!==null&&n.expiryTimeStamp!==undefined){if(n.expiredBody===null||n.expiredBody===undefined){return n.expiryTimeStamp}}var l=new Date(n.sentTimestamp);var m=new Date();m.setDate(l.getDate()+e.richMessageAvailabilityDays);return m.toISOString()},removeExpiredMessages:function(){var m=[];var l=this.load();var o=0;for(var n=l.length-1;n>=0;n--){if(this.isExpired(l[n])||!this.isAvailable(l[n])){i.donkyLogging.infoLog("messageId "+l[n].messageId+" is expired, deleting");m.push(l[n].messageId);l.splice(n,1);o++}}if(o>0){this.save(l)}return m},removeUnavailableMessages:function(){var m=[];var l=this.load();var o=0;for(var n=l.length-1;n>=0;n--){if(!this.isAvailable(l[n])){i.donkyLogging.infoLog("messageId "+l[n].messageId+" is unavailable, deleting");m.push(l[n].messageId);l.splice(n,1);o++}}if(o>0){this.save(l)}return m}};function j(m,n){var l=[];i._each(m,function(p,r){var q=r.data;q.serverNotificationId=r.id;q.isRead=false;q.receivedTimestamp=new Date().toISOString();var o=b.isExpired(q);h.markMessageReceived(r,o);if(!o){if(b.add(q)){l.push(q)}}});if(l.length>0&&n!==false){i.publishLocalEvent({type:"NewRichMessagesReceived",data:l})}}function d(l,n){var m=new RegExp("("+n+")","gi");return l.replace(m,"<em>$1</em>")}function c(l){var m=[];i._each(l,function(n,o){m.push(o.data.messageId)});b.removeMany(m);i.publishLocalEvent({type:"SyncRichMessagesDeleted",data:m})}function f(l){var m=[];i._each(l,function(n,o){m.push(o.data.messageId)});b.markManyAsRead(m);i.publishLocalEvent({type:"SyncRichMessagesRead",data:m})}function g(){var m=i.donkyData.get("configuration");if(m!==null&&m!==undefined&&m.configurationItems!==undefined){if(typeof m.configurationItems.richMessageAvailabilityDays=="string"){e.richMessageAvailabilityDays=parseInt(m.configurationItems.richMessageAvailabilityDays)}}b.removeUnavailableMessages();var l={name:"DonkyRichLogic",version:"2.0.1.0"};i.subscribeToDonkyNotifications(l,{notificationType:"RichMessage",batchHandler:j},false);i.subscribeToDonkyNotifications(l,[{notificationType:"SyncMessageRead",batchHandler:f},{notificationType:"SyncMessageDeleted",batchHandler:c}],true);i.subscribeToLocalEvent("RegistrationChanged",function(n){b.removeAll()})}g.prototype={getMessageCount:function(){try{var l=b.load();var m=0;i._each(l,function(o,p){if(p.isRead===false){m++}});return{richMessageCount:l.length,unreadRichMessageCount:m}}catch(n){i.donkyLogging.errorLog("caught exception in getMessageCounts() : "+n)}return null},deleteRichMessage:function(l){try{i.donkyLogging.debugLog("DonkyRichLogic.deleteRichMessage("+l+")");b.remove(l);h.markMessageDeleted(l,true);i.publishLocalEvent({type:"RichMessageDeleted",data:{messageId:l}})}catch(m){i.donkyLogging.errorLog("caught exception in deleteRichMessage() : "+m)}},deleteRichMessages:function(l){try{i.donkyLogging.debugLog("DonkyRichLogic.deleteRichMessages("+JSON.stringify(l)+")");b.removeMany(l);i._each(l,function(o,n){h.markMessageDeleted(n,o===l.length-1)});i.publishLocalEvent({type:"RichMessagesDeleted",data:{messageIds:l}})}catch(m){i.donkyLogging.errorLog("caught exception in deleteRichMessage() : "+m)}},filterRichMessages:function(o){try{var m=b.load();var l=[];i._each(m,function(p,q){if(q.description.toLowerCase().indexOf(o.toLowerCase())!=-1){q.description=d(q.description,o);l.push(q)}else{if(q.senderDisplayName.toLowerCase().indexOf(o.toLowerCase())!=-1){q.senderDisplayName=d(q.senderDisplayName,o);l.push(q)}}});return l}catch(n){i.donkyLogging.errorLog("caught exception in filterRichMessages() : "+n);return null}},getAllRichMessages:function(){try{return b.load()}catch(l){i.donkyLogging.errorLog("caught exception in getAllRichMessages() : "+l)}return null},markRichMessageRead:function(l){try{var m=b.findObj(l);if(m!==null&&!m.isRead){h.markMessageRead(m);b.markAsRead(m.messageId);i.publishLocalEvent({type:"RichMessageRead",data:{messageId:m.messageId}})}}catch(n){i.donkyLogging.errorLog("caught exception in markRichMessageRead() : "+n)}},getNextUnreadRichMessage:function(){try{return b.getNextUnread()}catch(l){i.donkyLogging.errorLog("caught exception in getNextRichMessage() : "+l)}return null},getRichMessage:function(l){try{return b.findObj(l)}catch(m){i.donkyLogging.errorLog("caught exception in getRichMessage() : "+m)}return null},getRichMessageExpiryTimeStamp:function(l){return b.getExpiryTimestamp(l)},isRichMessageAvailable:function(l){return b.isAvailable(l)},isRichMessageExpired:function(l){return b.isExpired(l)},removeExpiredMessages:function(){var l=b.removeExpiredMessages();if(l.length>0){i.publishLocalEvent({type:"RichMessageDeleted",data:{messageId:l}})}},removeUnavailableMessages:function(){var l=b.removeUnavailableMessages();if(l.length>0){i.publishLocalEvent({type:"RichMessageDeleted",data:{messageId:l}})}},};k=new g();i.registerService("donkyRichLogic",k);return k};if(typeof define==="function"&&define.amd){define("donkyRichLogic",["donkyCore","donkyMessagingCommon"],function(c,b){return a(c,b)})}else{window.donkyRichLogic=a(window.donkyCore,window.donkyMessagingCommon)}}());